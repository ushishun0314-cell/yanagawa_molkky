<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚„ãªãƒ¢ãƒ«</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0ea5e9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --acc:#0ea5e9; --ok:#10b981; --warn:#ef4444;
  }
  body{margin:0;background:#f7fafc;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif}
  header{position:sticky;top:0;background:#fff;z-index:10;border-bottom:1px solid #e5e7eb}
  .head-inner{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
  h1{font-size:18px;margin:0;display:flex;align-items:center;gap:8px}
  .logo{width:28px;height:28px;object-fit:cover;border-radius:6px}
  .container{max-width:1080px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border-radius:16px;box-shadow:0 2px 10px rgba(2,8,23,.06);padding:14px}

  /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šï¼ˆç¸¦ä¸¦ã³ï¼‰ */
  .players{display:flex;flex-direction:column;gap:10px}
  .player-row{
    display:flex;align-items:center;gap:10px;padding:10px;
    border:1px solid #e5e7eb;border-radius:12px;background:#fff;
  }
  .player-handle{
    width:34px;height:34px;border-radius:10px;border:1px solid #e5e7eb;
    display:flex;align-items:center;justify-content:center;background:#fff;
    font-size:18px;user-select:none;cursor:grab;flex:0 0 34px;
  }
  .player-row input{flex:1;min-height:42px;font-size:16px}
  .player-del{width:42px;height:42px;border-radius:10px;font-size:18px;line-height:1;cursor:pointer}

  /* æœ€è¿‘ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãƒãƒƒãƒ— */
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip-btn{
    border:1px solid #cfe7fb;background:#eef6ff;color:#0f172a;
    border-radius:999px;padding:6px 10px;font-size:14px;cursor:pointer;
  }
  .chip-btn:active{transform:translateY(1px)}

  input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  button{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer}
  button.primary{border-color:var(--acc);color:#fff;background:var(--acc)}
  button.warn{border-color:var(--warn);background:var(--warn);color:#fff}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{padding:4px 8px;border-radius:999px;background:#e5e7eb;color:#111;font-size:12px}
  .current{outline:2px solid var(--acc);border-radius:10px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:center;vertical-align:middle}
  th{font-weight:600;background:#f3f4f6}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .badge{font-size:12px;border-radius:6px;background:#e5e7eb;padding:2px 6px}
  .winner{background:var(--ok);color:#fff}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;transition:.2s;pointer-events:none}
  .toast.show{opacity:1}
  .spacer{flex:1}
  .btn-alt{border-color:#d1d5db}

  /* åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modalBG{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{max-width:1040px;width:100%;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px;max-height:90vh;overflow:auto}
  .bar{height:10px;border-radius:6px;background:#e5e7eb;overflow:hidden}
  .bar > span{display:block;height:100%}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#eef6ff;border:1px solid #cfe7fb;font-size:12px}
  .note{font-size:12px;color:#64748b}
  .grid-heat{display:grid;grid-template-columns:repeat(6,minmax(40px,1fr));gap:6px}
  .cell{border:1px solid #e5e7eb;border-radius:8px;padding:6px}

  /* ã‚¹ãƒãƒ› */
  @media (max-width: 640px){
    body{font-size:15px}
    .head-inner{padding:8px 12px}
    .container{padding:12px}
    th,td{padding:6px;font-size:13px}
    .grid{grid-template-columns:repeat(4,1fr);gap:6px}
    .grid button{padding:8px 6px;font-size:15px;min-height:38px}
    button{min-height:40px}
    input{min-height:40px}
    .player-row{padding:8px}
    .player-handle{width:30px;height:30px;font-size:16px}
    .player-del{width:38px;height:38px}
    .modal{width:100%;max-width:none;height:100svh;max-height:none;border-radius:0;padding:12px}
  }

  .tableWrap{overflow-x:auto}

  /* å‹åˆ©æ™‚ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç¶šè¡Œï¼çµ‚äº†ï¼‰ */
  .askBG{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60;padding:20px}
  .ask{background:#fff;border-radius:14px;max-width:420px;width:100%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .ask h3{margin:0 0 8px}
  .ask .row{justify-content:flex-end}
</style>
</head>
<body>
<header>
  <div class="head-inner">
    <img class="logo" src="icons/yanamol-hero.png" alt="ã‚„ãªãƒ¢ãƒ«">
    <h1>ã‚„ãªãƒ¢ãƒ«</h1>
    <div class="spacer"></div>
    <button id="openAnalytics" class="btn-alt">åˆ†æ</button>
  </div>
</header>

<div class="container">
  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
  <section class="card" id="setup">
    <h2 style="margin:0 0 8px">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

    <div id="playerList" class="players"></div>

    <!-- æœ€è¿‘ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãƒãƒƒãƒ— -->
    <div id="nameHistory" style="margin-top:8px"></div>

    <div class="row" style="margin-top:8px">
      <button id="addPlayerBtn">ï¼‹ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ </button>
      <button id="shuffleBtn" class="btn-alt">å…ˆæ”»ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
      <button id="startBtn" class="primary">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      <span class="muted">å…ˆé ­ã®ã€Œâ‰¡ã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆï¼ˆå…ˆæ”»æ±ºã‚ï¼‰</span>
    </div>
  </section>

  <!-- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
  <section class="card" id="board" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div>ç¾åœ¨ã®æŠ•æ“²: <span id="currentName" class="pill"></span></div>
      <div class="row">
        <button id="undoBtn" class="btn-alt">æˆ»ã‚‹</button>
        <button id="newGameBtn" class="btn-alt" title="çµ‚äº†å¾Œã«ä½¿ç”¨">æ–°ã—ã„ã‚²ãƒ¼ãƒ ï¼ˆå…ˆæ”»ãƒ­ãƒ¼ãƒ†ï¼‰</button>
        <button id="resetBtn" class="warn">è©¦åˆã‚„ã‚Šç›´ã—</button>
      </div>
    </div>

    <div class="tableWrap" style="margin-top:8px">
      <table id="scoreTable">
        <thead><tr id="scoreHead"></tr></thead>
        <tbody>
          <tr id="scoreRow"></tr>
          <tr id="remainRow"></tr>
          <tr id="statusRow"></tr>
        </tbody>
      </table>
    </div>

    <!-- å…¥åŠ› -->
    <div>
      <h3 style="margin:8px 0">å…¥åŠ›</h3>
      <div class="row"><span class="badge">å˜å“ï¼ˆãã®ç•ªå·ãŒå¾—ç‚¹ï¼‰</span></div>
      <div class="grid" id="singleRow"></div>
      <div class="row" style="margin-top:8px"><span class="badge">è¤‡æ•°ï¼ˆå€’ã—ãŸæœ¬æ•°ãŒå¾—ç‚¹ï¼‰</span></div>
      <div class="grid" id="multiRow"></div>
      <div class="row" style="margin-top:8px">
        <button id="missBtn">ãƒŸã‚¹ï¼ˆ0ï¼‰</button>
        <button id="shareBtn" class="btn-alt">çµæœã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div id="winnerBox" style="margin-top:12px"></div>
    <details style="margin-top:12px"><summary>å±¥æ­´</summary>
      <div id="historyBox" class="muted" style="white-space:pre-wrap"></div>
    </details>
  </section>
</div>

<!-- åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalBG" id="analyticsBG" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="anltTitle">
    <div class="row" style="justify-content:space-between">
      <div>
        <h2 id="anltTitle" style="margin:0">ã‚„ãªãƒ¢ãƒ«åˆ†æ</h2>
        <div class="note">ç«¯æœ«å†…ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆlocalStorageï¼‰ã€‚JSON/CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯ã€‚æ—¥åˆ¥ã‚µãƒãƒªãƒ¼CSVã‚‚å‡ºåŠ›ã€‚</div>
      </div>
      <div class="row">
        <button id="importJSON" class="btn-alt">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button id="exportJSON" class="btn-alt">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="exportCSV" class="btn-alt">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="exportDailyCSV" class="btn-alt">æ—¥åˆ¥ã‚µãƒãƒªãƒ¼CSV</button>
        <button id="closeAnalytics" class="primary">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div id="analyticsBody" style="margin-top:10px"></div>
  </div>
</div>

<!-- å‹åˆ©æ™‚ã®ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="askBG" id="askBG">
  <div class="ask">
    <h3 id="askTitle">å‹åˆ©</h3>
    <div id="askMsg" class="muted" style="margin-bottom:12px"></div>
    <div class="row">
      <button id="askCancel" class="btn-alt">çµ‚äº†</button>
      <button id="askOk" class="primary">ç¶šè¡Œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ====== DBï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ ======
  const DB_KEY = 'yanamol-db';
  const loadDB = () => { try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{"games":[]}'); }catch{ return {games:[]}; } };
  const saveDB = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));
  const appendGame = (game) => { const db=loadDB(); db.games.push(game); saveDB(db); };

  // ====== åå‰å±¥æ­´ ======
  const NAME_KEY = 'yanamol-name-history';
  function loadNames(){ try{ return JSON.parse(localStorage.getItem(NAME_KEY) || '[]'); }catch{ return []; } }
  function saveNames(arr){ localStorage.setItem(NAME_KEY, JSON.stringify(arr)); }
  function rememberName(name){
    name = String(name||'').trim();
    if(!name) return;
    const arr = loadNames().filter(n => n !== name);
    arr.unshift(name);
    saveNames(arr.slice(0,12));
    renderNameHistory();
  }
  function renderNameHistory(){
    const box = $("#nameHistory");
    const names = loadNames();
    if(!names.length){ box.innerHTML = ''; return; }
    box.innerHTML = `<div class="muted" style="margin:4px 0 6px">æœ€è¿‘ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>`;
    const wrap = el('div',{class:'chips'});
    names.forEach(n=>{
      const b = el('button',{class:'chip-btn', text:n, title:`${n} ã‚’è¿½åŠ `});
      b.addEventListener('click', ()=>{
        addPlayer(n); renderSetup(); save();
      });
      wrap.appendChild(b);
    });
    box.appendChild(wrap);
  }

  // ====== ã‚²ãƒ¼ãƒ é€²è¡Œã®state ======
  const initState = () => ({
    players: [], // {id,name,score,misses,out,overResets}
    order: [],   // player ids in orderï¼ˆå…ˆæ”»ï¼index0ï¼‰
    turnIdx: 0,
    history: [], // {pid, type:'single'|'multi'|'miss'|'over', value, prev, ts}
    finished: false,
    gameNo: 1,
    createdAt: Date.now(),
    gameId: null // yymmdd_n ã§å¾Œã‹ã‚‰æ¡ç•ª
  });
  let state = load() || initState();

  // ====== DOM helper ======
  const $ = (sel)=>document.querySelector(sel);
  const el = (tag,attrs={})=>{ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{
    if(k==='text') n.textContent=v; else if(k==='html') n.innerHTML=v; else if(k==='class') n.className=v; else n.setAttribute(k,v);
  }); return n; };
  const toast=(msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };

  // ====== storage for current session ======
  function save(){ localStorage.setItem('molkky-app', JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem('molkky-app')||'null'); }catch{ return null; } }

  // ====== Setup UI ======
  const playerList = $("#playerList");
  function renderSetup(){
    playerList.innerHTML='';
    state.players.forEach((p,i)=>{
      const row = el('div',{class:'player-row'});

      const handle = el('div',{class:'player-handle', title:'ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ', text:'â‰¡'});
      row.append(handle);

      const input = el('input',{value:p.name, 'aria-label':'åå‰'});
      input.enterKeyHint = 'next';
      input.addEventListener('input', ()=>{
        p.name = input.value.trim().slice(0,20)||`P${i+1}`;
        save();
      });
      input.addEventListener('change', ()=>{ rememberName(input.value); });
      row.append(input);

      const delBtn = el('button',{class:'player-del', text:'âœ•', title:'å‰Šé™¤'});
      delBtn.addEventListener('click', ()=>{
        state.players.splice(i,1);
        renderSetup(); save();
      });
      row.append(delBtn);

      // ä¸¦ã³æ›¿ãˆ
      row.draggable = true;
      row.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', i);
        row.style.opacity = .6;
      });
      row.addEventListener('dragend', ()=>{ row.style.opacity = 1; });
      row.addEventListener('dragover', e=>e.preventDefault());
      row.addEventListener('drop', e=>{
        e.preventDefault();
        const from = +e.dataTransfer.getData('text/plain');
        const to = i;
        if(from===to) return;
        const [moved] = state.players.splice(from,1);
        state.players.splice(to,0,moved);
        renderSetup(); save();
      });

      playerList.append(row);
    });

    if(state.players.length===0){
      const names = loadNames();
      if(names.length){
        names.slice(0,3).forEach(n=>addPlayer(n));
      }else{
        ['A','B','C'].forEach(n=>addPlayer(n));
      }
      renderSetup();
    }
  }
  function addPlayer(name){
    const id = self.crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());
    state.players.push({id,name,score:0,misses:0,out:false,overResets:0});
  }

  $("#addPlayerBtn").addEventListener('click', ()=>{ addPlayer(`P${state.players.length+1}`); renderSetup(); save(); });
  $("#shuffleBtn").addEventListener('click', ()=>{
    for(let i=state.players.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [state.players[i],state.players[j]]=[state.players[j],state.players[i]];
    }
    renderSetup(); toast('é †ç•ªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ'); save();
  });
  $("#startBtn").addEventListener('click', ()=>{
    state.players = state.players.filter(p=>p.name.trim()!=='');
    if(state.players.length<2){ toast('2äººä»¥ä¸Šã§é–‹å§‹ã—ã¦ãã ã•ã„'); return; }
    state.players.forEach(p => rememberName(p.name));

    state.order = state.players.map(p=>p.id);
    state.turnIdx = 0; state.history=[]; state.finished=false;
    state.players.forEach(p=>{ p.score=0; p.misses=0; p.out=false; p.overResets=0; });

    assignGameIdIfNeeded();
    applyOrderToPlayers();

    save(); switchToBoard();
  });

  // ====== Board ======
  const scoreHead = $("#scoreHead");
  const scoreRow = $("#scoreRow");
  const remainRow = $("#remainRow");
  const statusRow = $("#statusRow");

  function switchToBoard(){
    $("#setup").style.display='none';
    $("#board").style.display='';
    renderBoard();
  }
  function playerById(id){ return state.players.find(p=>p.id===id); }
  function aliveOrder(){ return state.order.filter(id=>!playerById(id).out); }
  function currentId(){ 
    const alive = aliveOrder(); 
    if(alive.length===0) return null;
    return alive[state.turnIdx % alive.length]; 
  }

  function renderBoard(){
    scoreHead.innerHTML='<th>é …ç›®</th>'+state.players.map(p=>`<th>${escapeHtml(p.name)}</th>`).join('');
    scoreRow.innerHTML=''; scoreRow.append(el('td',{text:'ã‚¹ã‚³ã‚¢'}));
    state.players.forEach(p=>{ scoreRow.append(el('td',{text:String(p.score)})); });

    remainRow.innerHTML=''; remainRow.append(el('td',{text:'æ®‹'}));
    state.players.forEach(p=>{
      const r = Math.max(0, 50 - p.score);
      const t = p.score>=50 ? 'â€”' : `${r}`;
      remainRow.append(el('td',{html:`<span class="pill">${t}</span>`}));
    });

    statusRow.innerHTML=''; statusRow.append(el('td',{text:'çŠ¶æ…‹'}));
    state.players.forEach(p=>{
      let s = '&nbsp;';
      if(p.score===50) s = '<span class="pill winner">å‹è€…</span>';
      else if(p.out) s = '<span class="pill">å¤±æ ¼</span>';
      else if(p.misses) s = `<span class="pill">ãƒŸã‚¹: ${p.misses}</span>`;
      statusRow.append(el('td',{html:s}));
    });

    const cid = currentId();
    const name = cid ? playerById(cid).name : '-';
    $("#currentName").textContent = name;
    [...scoreHead.children].forEach((th,i)=>{
      th.classList.toggle('current', cid && i===state.players.findIndex(p=>p.id===cid)+1);
    });

    renderWinnerBox();
    $("#newGameBtn").disabled = !state.finished;

    renderKeypads();
    renderHistory();
    save();
  }

  function renderKeypads(){
    const single = $("#singleRow"), multi=$("#multiRow");
    single.innerHTML=''; multi.innerHTML='';
    for(let n=1;n<=12;n++){
      const b = el('button',{text:String(n)});
      b.addEventListener('click', ()=>applyPlay({type:'single',value:n}));
      single.append(b);
    }
    for(let n=2;n<=12;n++){
      const b = el('button',{text:`${n}æœ¬`});
      b.addEventListener('click', ()=>applyPlay({type:'multi',value:n}));
      multi.append(b);
    }
  }

  $("#missBtn").addEventListener('click', ()=>applyPlay({type:'miss',value:0}));
  $("#undoBtn").addEventListener('click', undo);
  $("#resetBtn").addEventListener('click', ()=>{
    if(confirm('è©¦åˆã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')){ state = initState(); save(); location.reload(); }
  });
  $("#shareBtn").addEventListener('click', ()=>{
    const txt = exportText();
    navigator.clipboard?.writeText(txt).then(()=>toast('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>{ 
      const ta = el('textarea'); ta.value = txt; document.body.append(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    });
  });
  $("#newGameBtn").addEventListener('click', ()=>{
    if(!state.finished && !confirm('é€²è¡Œä¸­ã§ã™ãŒæ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) return;
    rotateFirst(); startNewGame();
  });

  // ====== ä¸¦ã³ & æ¡ç•ª ======
  function rotateFirst(){
    if(state.order.length>1){
      const first = state.order.shift();
      state.order.push(first);
    }
  }
  function applyOrderToPlayers(){
    const map = new Map(state.players.map(p => [p.id, p]));
    state.players = state.order.map(id => map.get(id)).filter(Boolean);
  }
  function assignGameIdIfNeeded(){
    if(state.gameId) return;
    const d = new Date(state.createdAt);
    const pad2 = n=>String(n).padStart(2,'0');
    const y = d.getFullYear()%100, m=pad2(d.getMonth()+1), day=pad2(d.getDate());
    const ymd = `${pad2(y)}${m}${day}`;
    const db = loadDB();
    const todayGames = db.games.filter(g=>{
      return typeof g.gameId==='string' && g.gameId.startsWith(`${ymd}_`);
    });
    const n = todayGames.length + 1;
    state.gameId = `${ymd}_${n}`;
  }

  function startNewGame(){
    state.createdAt = Date.now();
    state.gameId = null;
    assignGameIdIfNeeded();

    applyOrderToPlayers();

    state.players.forEach(p=>{ p.score=0; p.misses=0; p.out=false; p.overResets=0; });
    state.turnIdx = 0;
    state.history = [];
    state.finished = false;
    state.gameNo += 1;
    toast(`ã‚²ãƒ¼ãƒ  ${state.gameNo} ã‚’é–‹å§‹ï¼ˆå…ˆæ”»ãƒ­ãƒ¼ãƒ†é©ç”¨ï¼‰`);
    renderBoard();
  }

  // ====== å‹åˆ©ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç¶šè¡Œ / çµ‚äº† ======
  function askContinue(msg){
    return new Promise((resolve)=>{
      const bg = $("#askBG"); const ok=$("#askOk"); const cancel=$("#askCancel");
      $("#askTitle").textContent = "å‹åˆ©";
      $("#askMsg").innerHTML = msg.replace(/\n/g,'<br>');
      bg.style.display='flex';
      const clean = ()=>{ ok.onclick=null; cancel.onclick=null; bg.style.display='none'; };
      ok.onclick = ()=>{ clean(); resolve(true); };      // ç¶šè¡Œ
      cancel.onclick = ()=>{ clean(); resolve(false); }; // çµ‚äº†
    });
  }

  async function applyPlay({type,value}){
    if(state.finished) return;
    const cid = currentId(); if(!cid) return;
    const p = playerById(cid);
    const prev = {score:p.score,misses:p.misses,out:p.out,overResets:p.overResets};
    const ts = Date.now();
    let gained = 0;

    if(type==='miss'){
      p.misses += 1;
      if(p.misses>=3){ p.out = true; toast(`${p.name} ã¯3å›ãƒŸã‚¹ã§å¤±æ ¼`); }
      state.history.push({pid:cid,type:'miss',value:0,prev,ts});
    }else{
      p.misses = 0; gained = value; p.score += gained;
      if(p.score===50){
        toast(`${p.name} ãŒ50ç‚¹ï¼`);
        p.out = true;
        state.history.push({pid:cid,type, value:gained,prev,ts});

        const remaining = aliveOrder().length;
        if(remaining>=2){
          const cont = await askContinue(`${p.name} ãŒå‹åˆ©ã—ã¾ã—ãŸã€‚<br>æ®‹ã‚Šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ç¶šã‘ã¾ã™ã‹ï¼Ÿ`);
          if(cont){
            state.players.forEach(pp=>{ if(!pp.out) pp.misses=0; });
            advanceTurn(); renderBoard(); return;
          } else {
            state.finished = true;
          }
        } else {
          state.finished = true;
        }
      } else if(p.score>50){
        p.score = 25; p.overResets += 1; 
        toast(`${p.name} ã¯ã‚ªãƒ¼ãƒãƒ¼ï¼25ç‚¹ã¸`);
        state.history.push({pid:cid,type:'over', value:gained,prev,ts});
      } else {
        state.history.push({pid:cid,type, value:gained,prev,ts});
      }
    }

    advanceTurn();
    if(aliveOrder().length===0){ state.finished=true; }
    if(state.finished){ persistGame(); }
    renderBoard();
  }

  function advanceTurn(){
    const alive = aliveOrder();
    if(alive.length===0){ state.turnIdx = 0; return; }
    state.turnIdx = (state.turnIdx + 1) % alive.length;
  }

  function undo(){
    const h = state.history.pop(); if(!h) return;
    const aliveNow = aliveOrder();
    if(aliveNow.length>0){
      state.turnIdx = (state.turnIdx - 1 + aliveNow.length) % aliveNow.length;
    } else {
      state.turnIdx = 0;
    }
    const p = playerById(h.pid);
    p.score = h.prev.score; p.misses = h.prev.misses; p.out = h.prev.out; p.overResets = h.prev.overResets;
    state.finished = false;
    renderBoard();
  }

  function exportText(){
    const lines = [];
    lines.push(`ã€ã‚„ãªãƒ¢ãƒ« çµæœã€‘ï¼ˆGame ${state.gameNo} / ID: ${state.gameId})`);
    state.players.forEach(p=>{
      const status = p.out && p.score<50 ? 'ï¼ˆå¤±æ ¼ï¼‰' : (p.score===50?'ï¼ˆå‹è€…ï¼‰':'');
      lines.push(`${p.name}: ${p.score}ç‚¹ ${status}`);
    });
    lines.push('â€” è¨˜éŒ² â€”');
    state.history.forEach((h,i)=>{
      const p = playerById(h.pid);
      const t = h.type==='miss'?'ãƒŸã‚¹':(h.type==='single'?`å˜å“${h.value}`:h.type==='over'?`ã‚ªãƒ¼ãƒãƒ¼(${h.value})â†’25`:`è¤‡æ•°${h.value}æœ¬`);
      lines.push(`${i+1}. ${p.name} â†’ ${t}`);
    });
    return lines.join('\n');
  }

  function renderHistory(){
    const box = $("#historyBox");
    box.textContent = state.history.map((h,i)=>{
      const p = playerById(h.pid);
      const t = h.type==='miss'?'ãƒŸã‚¹':(h.type==='single'?`å˜å“${h.value}`:h.type==='over'?`ã‚ªãƒ¼ãƒãƒ¼(${h.value})â†’25`:`è¤‡æ•°${h.value}æœ¬`);
      return `${String(i+1).padStart(2,' ')}. ${p.name} â†’ ${t}`;
    }).join('\n');
  }

  function renderWinnerBox(){
    const wb = $("#winnerBox");
    const winners = state.players.filter(p=>p.score===50);
    if(winners.length){
      const names = winners.map(p=>escapeHtml(p.name)).join('ã€');
      const aliveCnt = aliveOrder().length;
      let html = `<div class="pill winner">å‹è€…ï¼š${names} ğŸ‰</div>`;
      if(!state.finished && aliveCnt>=2){
        html += `<div class="muted" style="margin-top:6px">æ®‹ã‚Šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ç¶šè¡Œä¸­</div>`;
      }
      if(state.finished){
        html += `<div style="margin-top:8px"><button id="finishNewGameBtn" class="primary">æ–°ã—ã„ã‚²ãƒ¼ãƒ ï¼ˆå…ˆæ”»ãƒ­ãƒ¼ãƒ†ï¼‰</button></div>`;
      }
      wb.innerHTML = html;
      document.querySelector("#finishNewGameBtn")?.addEventListener('click', ()=>{ rotateFirst(); startNewGame(); });
    } else {
      wb.innerHTML = '';
    }
  }

  function persistGame(){
    const db = loadDB();
    if(db.games.some(g=>g.gameId===state.gameId)) return;

    const players = state.players.map(p=>({id:p.id,name:p.name}));
    const winners = state.players.filter(p=>p.score===50).map(p=>p.id);
    const game = {
      gameId: state.gameId,
      startedAt: state.createdAt,
      endedAt: Date.now(),
      players,
      winners,
      order: state.order.slice(),
      plays: state.history.map(h=>({
        ts: h.ts, pid: h.pid, type: h.type, value: h.value,
        scoreBefore: h.prev.score, missesBefore: h.prev.misses
      }))
    };
    appendGame(game);
    toast('è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }

  function escapeHtml(str){ return String(str).replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

  // ====== åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« ======
  $("#openAnalytics").addEventListener('click', ()=>{
    renderAnalytics(); $("#analyticsBG").style.display='flex'; $("#analyticsBG").setAttribute('aria-hidden','false');
  });
  $("#closeAnalytics").addEventListener('click', ()=>{
    $("#analyticsBG").style.display='none'; $("#analyticsBG").setAttribute('aria-hidden','true');
  });

  // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  $("#importJSON").addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      try{
        const text = await file.text();
        const incoming = JSON.parse(text);
        if(!incoming || !Array.isArray(incoming.games)) throw new Error('å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆgamesãŒã‚ã‚Šã¾ã›ã‚“ï¼‰');

        const db = loadDB();
        let add = 0, skip = 0;
        incoming.games.forEach(g=>{
          if(db.games.some(x=>x.gameId===g.gameId)){ skip++; return; }
          db.games.push(g); add++;
        });
        saveDB(db);
        toast(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼šè¿½åŠ  ${add} / é‡è¤‡ã‚¹ã‚­ãƒƒãƒ— ${skip}`);
        renderAnalytics();
      }catch(err){
        console.error(err);
        alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONã®å½¢å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      }
    };
    input.click();
  });

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
  $("#exportJSON").addEventListener('click', ()=>{
    const db = loadDB(); const blob = new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); download(url,'yanamol-data.json');
  });
  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰
  $("#exportCSV").addEventListener('click', ()=>{
    const db = loadDB();
    const rows = [['gameId','ts','date','player','type','value','scoreBefore','missesBefore']];
    db.games.forEach(g=>{
      const date = (new Date(g.startedAt)).toISOString().slice(0,10);
      const nameById = Object.fromEntries(g.players.map(p=>[p.id,p.name]));
      g.plays.forEach(p=>{
        rows.push([g.gameId, new Date(p.ts).toISOString(), date, nameById[p.pid]||p.pid, p.type, p.value, p.scoreBefore, p.missesBefore]);
      });
    });
    const csv = rows.map(r=>r.map(x=>String(x).includes(',')?`"${String(x).replace(/"/g,'""')}"`:String(x)).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); download(url,'yanamol-data.csv');
  });
  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆæ—¥åˆ¥ã‚µãƒãƒªãƒ¼ï¼‰
  $("#exportDailyCSV").addEventListener('click', ()=>{
    const db = loadDB();
    const sum = new Map(); // key=date|name -> stats
    const getKey = (date,name)=>`${date}|${name}`;
    db.games.forEach(g=>{
      const date = (new Date(g.startedAt)).toISOString().slice(0,10);
      const nameById = Object.fromEntries(g.players.map(p=>[p.id,p.name]));
      const gameWinners = new Set(g.winners);

      // åˆæœŸåŒ–ï¼ˆã‚²ãƒ¼ãƒ å‚åŠ /å‹ã¡ï¼‰
      g.players.forEach(pl=>{
        const name = pl.name;
        const key = getKey(date,name);
        if(!sum.has(key)) sum.set(key,{games:0,wins:0,throws:0,points:0,miss:0,single:0,multi:0});
        sum.get(key).games += 1;
        if(gameWinners.has(pl.id)) sum.get(key).wins += 1;
      });

      g.plays.forEach(p=>{
        const name = nameById[p.pid] || p.pid;
        const key = getKey(date,name);
        if(!sum.has(key)) sum.set(key,{games:0,wins:0,throws:0,points:0,miss:0,single:0,multi:0});
        sum.get(key).throws += 1;
        if(p.type==='miss'){ sum.get(key).miss += 1; }
        else{
          const add = p.value||0; sum.get(key).points += add;
          if(p.type==='single') sum.get(key).single += 1;
          if(p.type==='multi')  sum.get(key).multi  += 1;
        }
      });
    });

    const rows = [['date','player','games','wins','win_rate(%)','throws','points','avg_per_throw','single(%)','multi(%)','miss(%)']];
    sum.forEach((v,key)=>{
      const [date,name] = key.split('|');
      const denomScore = (v.single+v.multi)||1;
      const winRate = v.games? (v.wins/v.games*100):0;
      const avg = v.throws? (v.points/v.throws):0;
      const singlePct = (v.single/denomScore*100);
      const multiPct = (v.multi/denomScore*100);
      const missPct = v.throws? (v.miss/v.throws*100):0;
      rows.push([date,name,v.games,v.wins,winRate.toFixed(1),v.throws,v.points,avg.toFixed(2),singlePct.toFixed(1),multiPct.toFixed(1),missPct.toFixed(1)]);
    });

    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); download(url,'yanamol-daily-summary.csv');
  });

  function download(url, filename){
    const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1000);
  }

  function renderAnalytics(){
    const host = $("#analyticsBody"); host.innerHTML='';
    const db = loadDB();
    if(!db.games.length){
      host.innerHTML = `<div class="muted">ã¾ã ä¿å­˜ã•ã‚ŒãŸè©¦åˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯1è©¦åˆãƒ—ãƒ¬ã‚¤ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</div>`;
      return;
    }

    // æ¦‚è¦
    const allPlays = db.games.reduce((acc,g)=>acc+g.plays.length,0);
    const totalDurationMs = db.games.reduce((acc,g)=>acc+(g.endedAt-g.startedAt),0);
    const avgSecPerTurn = allPlays? (totalDurationMs/1000/allPlays):0;
    const head = el('div',{class:'row'});
    head.append(el('div',{class:'chip',html:`ç·è©¦åˆ <b>${db.games.length}</b>`}));
    head.append(el('div',{class:'chip',html:`ç·æŠ•æ“² <b>${allPlays}</b>`}));
    head.append(el('div',{class:'chip',html:`å¹³å‡/æŠ•æ“² <b>${avgSecPerTurn.toFixed(1)}s</b>`}));
    host.appendChild(head);

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›†è¨ˆï¼ˆå‹ç‡ãƒ»å˜å“/è¤‡æ•°æ¯”ç‡ãƒ»å…ˆæ”»åˆæŠ•å¹³å‡ï¼‰
    const stat = new Map(); // name -> stats
    const firstIdOfGame = g=> g.order[0];

    db.games.forEach(g=>{
      const nameById = Object.fromEntries(g.players.map(p=>[p.id,p.name]));

      g.players.forEach(pl=>{
        const name = pl.name;
        if(!stat.has(name)) stat.set(name,{
          games:0,wins:0,throws:0,points:0,miss:0,single:0,multi:0,over:0,
          firstThrows:0,firstPoints:0, // å…ˆæ”»ã§ã®å…¨æŠ•ï¼ˆå‚è€ƒï¼‰
          lateThrows:0, latePoints:0,  // å¾Œæ”»ã§ã®å…¨æŠ•ï¼ˆå‚è€ƒï¼‰
          heat: Array(13).fill(0),
          // å…ˆæ”»â€œåˆæŠ•â€ã ã‘ã®é›†è¨ˆ
          ft1Count:0, ft1Points:0
        });
      });

      // å…ˆæ”»ã®åˆæŠ•æ¤œå‡ºç”¨
      const leaderId = firstIdOfGame(g);
      let leaderFirstTaken = false;

      g.plays.forEach(p=>{
        const name = nameById[p.pid] || p.pid; 
        const s = stat.get(name);
        s.throws += 1;
        const addForAvg = (p.type==='miss') ? 0 : (p.value||0);

        // å‚è€ƒï¼šå…ˆæ”»/å¾Œæ”»ã®å…¨æŠ•
        if(p.pid === leaderId){ s.firstThrows += 1; s.firstPoints += addForAvg; }
        else                  { s.lateThrows  += 1; s.latePoints  += addForAvg; }

        // â˜… å…ˆæ”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã€Œãã®ã‚²ãƒ¼ãƒ æœ€åˆã®1æŠ•ã€ã ã‘ã‚’ä¸€åº¦ã ã‘æ‹¾ã†
        if (!leaderFirstTaken && p.pid === leaderId){
          const leaderName = nameById[leaderId] || leaderId;
          const sl = stat.get(leaderName);
          sl.ft1Count += 1;
          sl.ft1Points += addForAvg;
          leaderFirstTaken = true;
        }

        // å¾—ç‚¹å†…è¨³
        if(p.type==='miss'){
          s.miss += 1;
        }else{
          s.points += addForAvg;
          if(p.type==='single'){ s.single += 1; if(p.value>=1 && p.value<=12) s.heat[p.value] += 1; }
          else if(p.type==='multi'){ s.multi += 1; }
          else if(p.type==='over'){ s.over += 1; }
        }
      });

      const nameByIdWin = Object.fromEntries(g.players.map(p=>[p.id,p.name]));
      g.players.forEach(pl=>{ const name = pl.name; stat.get(name).games += 1; });
      g.winners.forEach(pid=>{ const name = nameByIdWin[pid] || pid; stat.get(name).wins += 1; });
    });

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>è©¦åˆ</th><th>å‹</th><th>å‹ç‡</th><th>æŠ•æ“²</th>
          <th>ç·å¾—ç‚¹</th><th>å¹³å‡/æŠ•æ“²</th><th>ãƒŸã‚¹ç‡</th>
          <th>å…ˆæ”» åˆæŠ•å¹³å‡</th>
          <th>å¾Œæ”» å¹³å‡/æŠ•</th>
          <th>å˜å“æ¯”ç‡</th><th>è¤‡æ•°æ¯”ç‡</th>
        </tr>
      </thead>
      <tbody></tbody>`;
    const tbody = table.querySelector('tbody');

    let maxAvg = 0; stat.forEach(s=>{ const avg = s.throws? (s.points/s.throws):0; if(avg>maxAvg) maxAvg=avg; });
    stat.forEach((s,name)=>{
      const avg = s.throws? (s.points/s.throws):0;
      const missRate = s.throws? (s.miss/s.throws*100):0;
      const lateAvg  = s.lateThrows ? (s.latePoints /s.lateThrows ):0;
      const ft1Avg   = s.ft1Count   ? (s.ft1Points /s.ft1Count   ):0;
      const denomScore = (s.single + s.multi) || 1;
      const singlePct = s.single/denomScore*100;
      const multiPct  = s.multi /denomScore*100;
      const winRate   = s.games? (s.wins/s.games*100):0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left;font-weight:600">${escapeHtml(name)}</td>
        <td>${s.games}</td>
        <td>${s.wins}</td>
        <td>${winRate.toFixed(1)}%</td>
        <td>${s.throws}</td>
        <td>${s.points}</td>
        <td>
          <div class="bar"><span style="width:${maxAvg? (avg/maxAvg*100):0}%; background:${avg>=4?'#10b981':'#60a5fa'}"></span></div>
          <div class="note">${avg.toFixed(2)}</div>
        </td>
        <td>
          <div class="bar"><span style="width:${missRate}%; background:#fda4af"></span></div>
          <div class="note">${missRate.toFixed(1)}%</div>
        </td>
        <td>${ft1Avg.toFixed(2)} <span class="note">(${s.ft1Count})</span></td>
        <td>${lateAvg.toFixed(2)}</td>
        <td>${singlePct.toFixed(1)}% <span class="note">(${s.single})</span></td>
        <td>${multiPct.toFixed(1)}% <span class="note">(${s.multi})</span></td>`;
      tbody.appendChild(tr);
    });
    host.appendChild(table);

    // å˜å“ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
    const heatWrap = el('div', {style:'margin-top:10px'});
    heatWrap.append(el('h3',{text:'å˜å“ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆ1-12ï¼‰'}));
    const maxCount = Array.from(stat.values()).reduce((m,s)=>Math.max(m, ...(s.heat||[0])),0) || 1;
    stat.forEach((s,name)=>{
      const sec = el('div',{class:'card', style:'margin-top:6px'});
      sec.append(el('div',{html:`<b>${escapeHtml(name)}</b>`}));
      const grid = el('div',{class:'grid-heat'});
      for(let n=1;n<=12;n++){
        const c = s.heat[n]||0; const pct = Math.round((c/maxCount)*100);
        const cell = el('div',{class:'cell', html:`<div>${n}</div><div class="note">${c}</div>`, style:`background:linear-gradient(0deg, rgba(14,165,233,0.${Math.min(9,Math.max(1,Math.ceil(pct/12)))}) ${pct}%, rgba(255,255,255,1) ${pct}%);`});
        grid.append(cell);
      }
      sec.append(grid); heatWrap.append(sec);
    });
    host.appendChild(heatWrap);
  }

  // èµ·å‹•
  renderSetup();
  renderNameHistory();
  if(state.players.length && state.order.length){ switchToBoard(); renderBoard(); }
})();
</script>

<!-- PWA: SW ç™»éŒ² -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>
</body>
</html>
